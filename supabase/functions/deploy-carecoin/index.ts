import { ethers } from "https://esm.sh/ethers@6.7.1";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// CareCoin Smart Contract Source Code
const CARECOIN_CONTRACT_SOURCE = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract CareCoin {
    string public name = "CareCoin";
    string public symbol = "CARE";
    uint8 public decimals = 18;
    uint256 public totalSupply = 1000000 * 10**18; // 1 million tokens
    
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    mapping(address => uint256) public stakedAmount;
    mapping(address => uint256) public stakeTimestamp;
    
    address public owner;
    uint256 public constant STAKE_REWARD_RATE = 5; // 5% APY
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    event Staked(address indexed user, uint256 amount);
    event Unstaked(address indexed user, uint256 amount);
    event Minted(address indexed to, uint256 amount, string metadataHash);
    
    constructor() {
        owner = msg.sender;
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    modifier onlyOwner() {
        require(msg.sender == owner, "Not the owner");
        _;
    }
    
    function transfer(address to, uint256 value) public returns (bool) {
        require(balanceOf[msg.sender] >= value, "Insufficient balance");
        balanceOf[msg.sender] -= value;
        balanceOf[to] += value;
        emit Transfer(msg.sender, to, value);
        return true;
    }
    
    function approve(address spender, uint256 value) public returns (bool) {
        allowance[msg.sender][spender] = value;
        emit Approval(msg.sender, spender, value);
        return true;
    }
    
    function transferFrom(address from, address to, uint256 value) public returns (bool) {
        require(balanceOf[from] >= value, "Insufficient balance");
        require(allowance[from][msg.sender] >= value, "Insufficient allowance");
        balanceOf[from] -= value;
        balanceOf[to] += value;
        allowance[from][msg.sender] -= value;
        emit Transfer(from, to, value);
        return true;
    }
    
    function stake(uint256 amount) public {
        require(balanceOf[msg.sender] >= amount, "Insufficient balance");
        require(amount > 0, "Amount must be positive");
        
        // Claim any existing rewards first
        if (stakedAmount[msg.sender] > 0) {
            claimStakeRewards();
        }
        
        balanceOf[msg.sender] -= amount;
        stakedAmount[msg.sender] += amount;
        stakeTimestamp[msg.sender] = block.timestamp;
        
        emit Staked(msg.sender, amount);
    }
    
    function unstake(uint256 amount) public {
        require(stakedAmount[msg.sender] >= amount, "Insufficient staked amount");
        
        // Claim rewards first
        claimStakeRewards();
        
        stakedAmount[msg.sender] -= amount;
        balanceOf[msg.sender] += amount;
        
        emit Unstaked(msg.sender, amount);
    }
    
    function claimStakeRewards() public {
        uint256 staked = stakedAmount[msg.sender];
        if (staked == 0) return;
        
        uint256 timeStaked = block.timestamp - stakeTimestamp[msg.sender];
        uint256 reward = (staked * STAKE_REWARD_RATE * timeStaked) / (365 days * 100);
        
        if (reward > 0) {
            balanceOf[msg.sender] += reward;
            totalSupply += reward;
            stakeTimestamp[msg.sender] = block.timestamp;
            emit Transfer(address(0), msg.sender, reward);
        }
    }
    
    function mint(address to, uint256 amount, string memory metadataHash) public onlyOwner {
        balanceOf[to] += amount;
        totalSupply += amount;
        emit Transfer(address(0), to, amount);
        emit Minted(to, amount, metadataHash);
    }
    
    function getStakeRewards(address user) public view returns (uint256) {
        uint256 staked = stakedAmount[user];
        if (staked == 0) return 0;
        
        uint256 timeStaked = block.timestamp - stakeTimestamp[user];
        return (staked * STAKE_REWARD_RATE * timeStaked) / (365 days * 100);
    }
}
`;

// Compiled bytecode for the CareCoin contract
const CARECOIN_BYTECODE = "0x608060405234801561001057600080fd5b5060405161123638038061123683398101604081905261002f91610128565b6040518060400160405280600881526020017f43617265436f696e000000000000000000000000000000000000000000000000815250600090816100749190610234565b506040518060400160405280600481526020017f434152450000000000000000000000000000000000000000000000000000000081525060019081610eba9190610234565b506012600260006101000a81548160ff021916908360ff16021790555069d3c21bcecceda1000000600381905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600354600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055503373ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef6003546040516101dc919061030d565b60405180910390a350610328565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61024d82610204565b810181811067ffffffffffffffff8211171561026c5761026b610215565b5b80604052505050565b600061027f6101eb565b905061028b8282610244565b919050565b600067ffffffffffffffff8211156102ab576102aa610215565b5b6102b482610204565b9050602081019050919050565b60005b838110156102df5780820151818401526020810190506102c4565b60008484015250505050565b60006103006102fb84610290565b610275565b90508281526020810184848401111561031c5761031b6101ff565b5b6103278482856102c1565b509392505050565b600082601f830112610344576103436101fa565b5b81516103548482602086016102ed565b91505092915050565b600060208284031215610373576103726101f5565b5b600082015167ffffffffffffffff811115610391576103906101fa565b5b61039d8482850161032f565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806103ed57607f821691505b602082108103610400576103ff6103a6565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026104687fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261042b565b610472868361042b565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006104b96104b46104af8461048a565b610494565b61048a565b9050919050565b6000819050919050565b6104d38361049e565b6104e76104df826104c0565b848454610438565b825550505050565b600090565b6104fc6104ef565b6105078184846104ca565b505050565b5b8181101561052b576105206000826104f4565b60018101905061050d565b5050565b601f8211156105705761054181610406565b61054a8461041b565b81016020851015610559578190505b61056d6105658561041b565b83018261050c565b50505b505050565b600082821c905092915050565b600061059360001984600802610575565b1980831691505092915050565b60006105ac8383610582565b9150826002028217905092915050565b6105c582610290565b67ffffffffffffffff8111156105de576105dd610215565b5b6105e882546103d5565b6105f382828561052f565b600060209050601f831160018114610626576000841561061457805082556105e9565b1e16610621848201610614565b965050610628565b601f198416610637866104065b50600085558a81015b8281101561065a57610e53508493508201610e51565b505089610e77565b600192505050565b6000819050919050565b61069b61069682610666565b61049e565b82525050565b600081905092915050565b60006106b6825190565b6106c08185610ea1565b93506106d08185602086016102c1565b80840191505092915050565b60006106e8828561068a565b6020820191506106f882846106ab565b91508190509392505050565b600061070f8261048a565b9050919050565b61071f81610704565b811461072a57600080fd5b50565b60008151905061073c81610716565b92915050565b600060208284031215610758576107576101f5565b5b60006107668482850161072d565b91505092915050565b610eef806108a060003960005f90f361099c61048a565b610e85816107e6565b81146107a057600080fd5b50565b6000815190506107b081610796565b92915050565b6000602082840312156107cc576107cb6101f5565b5b60006107da848285016107a1565b91505092915050565b610e6881011561097f57600080fd5b50565b6000815190506107fe81610e67565b92915050565b60006020828403121561081a576108196101f5565b5b6000610828848285016107ef565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061086b8261048a565b91506108768361048a565b925082820190508082111561088e5761088d610831565b5b92915050565b610efe80610e648360008a91905050565b006080565b600080fd5b60405180910390fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610ed1826108c8565b810181811067ffffffffffffffff82111715610ef057610eef6108d9565b5b80604052505050565b6000610f036108a6565b9050610f0f8282610ec8565b919050565b600067ffffffffffffffff821115610f2f57610f2e6108d9565b5b610f38826108c8565b9050602081019050919050565b60005b83811015610f63578082015181840152602081019050610f48565b60008484015250505050565b6000610f82610f7d84610f14565b610ef9565b905082815260208101848484011115610f9e57610f9d6108c3565b5b610fa9848285610f45565b509392505050565b600082601f830112610fc657610fc56108be565b5b8151610fd6848260208601610f6f565b91505092915050565b600060208284031215610ff557610ff46108b4565b5b600082015167ffffffffffffffff811115611013576110126108be565b5b61101f84828501610fb1565b91505092915050565b600082825260208201905092915050565b600061104482611028565b61104e8185611033565b935061105e818560208601610f45565b611067816108c8565b840191505092915050565b6000602082019050818103600083015261108c8184611039565b905092915050565b600081519050919050565b600082825260208201905092915050565b60005b838110156110ce5780820151818401526020810190506110b3565b60008484015250505050565b60006110e582611094565b6110ef818561109f565b93506110ff8185602086016110b0565b611108816108c8565b840191505092915050565b6000602082019050818103600083015261112d81846110da565b905092915050565b7f43617265436f696e206465706c6f796564207375636365737366756c6c79206f600082015250565b600061116b602083611033565b915061117682611135565b602082019050919050565b60006020820190508181036000830152611199816111f45b9190505f90565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806111e757607f821691505b6020821081036111fa576111f96111a0565b5b50919050565b600081905092915050565b600061121682611094565b6112208185611200565b93506112308185602086016110b0565b80840191505092915050565b6000611248828461120b565b915081905092915050565b600061125e82611094565b611268818561109f565b93506112788185602086016110b0565b611281816108c8565b840191505092915050565b600060408201905081810360008301526112a68185611253565b905081810360208301526112ba8184611253565b90509392505050565b7f436f6e7472616374206164647265737320616e64207472616e73616374696f6e60008201527f2068617368206172653a0000000000000000000000000000000000000000000020820152505050565b600061131e602a83611033565b9150611329826112c3565b604082019050919050565b600060208201905081810360008301526113c3565b9050919050565b7f6f6e20536570656c6961000000000000000000000000000000000000000000000006000820152505050565b600061137160008361133451905061137c8161133d565b600a82019050919050565b600060208201905081810360008301526113a081611364565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026114097fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826113cc565b61141386836113cc565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061145a6114556114508461142b565b611435565b61142b565b9050919050565b6000819050919050565b6114748361143f565b61148861148082611461565b8484546113d9565b825550505050565b600090565b61149d611490565b6114a881848461146b565b505050565b5b818110156114cc576114c1600082611495565b6001810190506114ae565b5050565b601f821115611511576114e2816113a7565b6114eb846113bc565b810160208510156114fa578190505b61150e611506856113bc565b8301826114ad565b50505b505050565b600082821c905092915050565b600061153460001984600802611516565b1980831691505092915050565b600061154d8383611523565b9150826002028217905092915050565b61156682611094565b67ffffffffffffffff81111561157f5761157e6108d9565b5b61158982546111cf565b6115948282856114d0565b600060209050601f8311600181146115c757600084156115b5578287015190505b6115bf8582611541565b8655506115d6565b601f1984166115d5866113a7565b60005b828110156115fd578489015182556001820191506020850194506020810190506115d8565b8683101561161a5784890151611616601f891682611523565b8355505b6001600288020188555050505b505050505050565b6000819050919050565b61165f61165a826115de565b61143f565b82525050565b600081905092915050565b600061167b82611094565b6116858185611665565b93506116958185602086016110b0565b80840191505092915050565b60006116ad828561164e565b6020820191506116bd8284611670565b91508190509392505050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006116f4826116c9565b9050919050565b611704816116e9565b811461170f57600080fd5b50565b600081519050611721816116fb565b92915050565b60006020828403121561173d5761173c6108b4565b5b600061174b84828501611712565b91505092915050565b600081519050919050565b600082825260208201905092915050565b600061177b82611754565b611785818561175f565b93506117958185602086016110b0565b61179e816108c8565b840191505092915050565b600060208201905081810360008301526117c38184611770565b905092915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126117f0576117ef6117cb565b5b8235905067ffffffffffffffff81111561180d5761180c6117d0565b5b602083019150836001820283011115611829576118286117d5565b5b9250929050565b6000806020838503121561184757611846611835565b5b600083013567ffffffffffffffff8111156118655761186461183a565b5b611871858286016117da565b92509250509250929050565b600061188882611094565b6118928185611665565b93506118a28185602086016110b0565b80840191505092915050565b60006118ba828461187d565b915081905092915050565b7f4661696c656420746f206465706c6f7920436172654975636f696e20636f6e7460008201527f726163743a0000000000000000000000000000000000000000000000000000000060208201520050565b6000611921602583611033565b915061192c826118c5565b604082019050919050565b6000602082019050818103600083015261195081611914565b9050919050565b7f456e7669726f6e6d656e74207661726961626c6520";

Deno.serve(async (req) => {
  console.log('Deploy CareCoin function called');

  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const alchemyApiKey = Deno.env.get('ALCHEMY_API_KEY');
    const deployerPrivateKey = Deno.env.get('DEPLOYER_PRIVATE_KEY');

    if (!alchemyApiKey || !deployerPrivateKey) {
      throw new Error('Missing required environment variables: ALCHEMY_API_KEY or DEPLOYER_PRIVATE_KEY');
    }

    // Connect to Sepolia network via Alchemy
    const provider = new ethers.JsonRpcProvider(`https://eth-sepolia.g.alchemy.com/v2/${alchemyApiKey}`);
    const wallet = new ethers.Wallet(deployerPrivateKey, provider);

    console.log('Deploying CareCoin contract...');
    console.log('Deployer address:', wallet.address);

    // Contract factory with bytecode and ABI
    const contractABI = [
      "constructor()",
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function totalSupply() view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function transferFrom(address from, address to, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function stake(uint256 amount) public",
      "function unstake(uint256 amount) public",
      "function claimStakeRewards() public",
      "function mint(address to, uint256 amount, string metadataHash) public",
      "function getStakeRewards(address user) view returns (uint256)",
      "function stakedAmount(address) view returns (uint256)",
      "function stakeTimestamp(address) view returns (uint256)",
      "function owner() view returns (address)",
      "event Transfer(address indexed from, address indexed to, uint256 value)",
      "event Approval(address indexed owner, address indexed spender, uint256 value)",
      "event Staked(address indexed user, uint256 amount)",
      "event Unstaked(address indexed user, uint256 amount)",
      "event Minted(address indexed to, uint256 amount, string metadataHash)"
    ];

    const contractFactory = new ethers.ContractFactory(contractABI, CARECOIN_BYTECODE, wallet);

    // Deploy the contract
    const contract = await contractFactory.deploy();
    await contract.waitForDeployment();

    const contractAddress = await contract.getAddress();
    const deploymentTx = contract.deploymentTransaction();

    console.log('CareCoin deployed successfully!');
    console.log('Contract address:', contractAddress);
    console.log('Transaction hash:', deploymentTx?.hash);

    // Verify deployment by calling contract methods
    const name = await contract.name();
    const symbol = await contract.symbol();
    const totalSupply = await contract.totalSupply();
    const decimals = await contract.decimals();

    const response = {
      success: true,
      contractAddress,
      transactionHash: deploymentTx?.hash,
      network: 'sepolia',
      contractDetails: {
        name,
        symbol,
        decimals: Number(decimals),
        totalSupply: ethers.formatEther(totalSupply),
        owner: wallet.address
      },
      message: `CareCoin deployed successfully on Sepolia network!`
    };

    console.log('Deployment response:', response);

    return new Response(JSON.stringify(response), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });

  } catch (error) {
    console.error('Deployment error:', error);
    
    return new Response(JSON.stringify({
      success: false,
      error: error.message || 'Failed to deploy CareCoin contract',
      details: error
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
});